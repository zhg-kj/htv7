{"ast":null,"code":"import localStorageTTL from \"../components/localStorageTTL\";\nclass DesoIdentity {\n  constructor() {\n    this.init = false;\n    this.pm_id = '';\n    this.source = null;\n    this.user = null;\n    this.pendingRequests = [];\n    this.identityWindow = null;\n    this.loginResolve = null;\n    this.signTxResolve = null;\n    this.IdentityUsersKey = \"identityUsersV2\";\n    this.transactionHex = \"\";\n    this.addListener();\n  }\n  loginAsync(accessLevel) {\n    return new Promise((resolve, reject) => {\n      this.identityWindow = window.open('https://identity.deso.org/log-in?accessLevelRequest=' + accessLevel, null, 'toolbar=no, width=800, height=1000, top=0, left=0');\n      this.loginResolve = resolve;\n    });\n  }\n  logout(publicKey) {\n    this.identityWindow = window.open('https://identity.deso.org/logout?publicKey=' + publicKey, null, 'toolbar=no, width=800, height=1000, top=0, left=0');\n    localStorage.removeItem(this.IdentityUsersKey);\n  }\n  logoutAsync(publicKey) {\n    return new Promise((resolve, reject) => {\n      this.identityWindow = window.open('https://identity.deso.org/logout?publicKey=' + publicKey, null, 'toolbar=no, width=800, height=1000, top=0, left=0');\n      this.loginResolve = resolve;\n    });\n  }\n  signTxAsync(transactionHex) {\n    return new Promise((resolve, reject) => {\n      this.signTxResolve = resolve;\n      this.transactionHex = transactionHex;\n      this.getInfo();\n      const id = this.uuid();\n      const user = JSON.parse(localStorage.getItem(this.IdentityUsersKey));\n      const payload = {\n        accessLevel: user.accessLevel,\n        accessLevelHmac: user.accessLevelHmac,\n        encryptedSeedHex: user.encryptedSeedHex,\n        transactionHex: transactionHex\n      };\n      this.source.postMessage({\n        id: id,\n        service: 'identity',\n        method: 'sign',\n        payload: payload\n      }, \"*\");\n    });\n  }\n  approveSignTx(transactionHex) {\n    this.identityWindow = window.open('https://identity.deso.org/approve?tx=' + transactionHex, null, 'toolbar=no, width=800, height=1000, top=0, left=0');\n  }\n  uuid() {\n    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n      var r = Math.random() * 16 | 0,\n        v = c === 'x' ? r : r & 0x3 | 0x8;\n      return v.toString(16);\n    });\n  }\n  getInfo() {\n    console.log(\"getinfo\");\n    const id = this.uuid();\n    this.source.postMessage({\n      id: id,\n      service: 'identity',\n      method: 'info'\n    }, \"*\");\n  }\n  handleLogin(payload) {\n    console.log(payload);\n    if (this.identityWindow) {\n      this.identityWindow.close();\n      this.identityWindow = null;\n      const user = payload.users[payload.publicKeyAdded];\n      if (Object.keys(payload.users).length !== 0 && !user) {\n        return;\n      }\n      if (user) {\n        user['publicKey'] = payload.publicKeyAdded;\n      }\n      localStorageTTL.setWithExpiry(this.IdentityUsersKey, JSON.stringify(user), 10000000000000);\n      this.loginResolve(user);\n    }\n  }\n  handleSign(payload) {\n    console.log(payload);\n    const signedTransactionHex = payload['signedTransactionHex'];\n    if (this.identityWindow) {\n      this.identityWindow.close();\n      this.identityWindow = null;\n    }\n    this.signTxResolve(signedTransactionHex);\n  }\n  respond(e, t, n) {\n    e.postMessage({\n      id: t,\n      service: \"identity\",\n      payload: n\n    }, \"*\");\n  }\n  handleInit(e) {\n    if (!this.init) {\n      this.init = true;\n      for (const e of this.pendingRequests) {\n        console.log(\"i'm in the pendingRequests loop\");\n        e.source.postMessage(e, \"*\");\n      }\n      this.pendingRequests = [];\n      this.pm_id = e.data.id;\n      this.source = e.source;\n      console.log('this.source', this.source);\n    }\n    this.respond(e.source, e.data.id, {});\n  }\n  postMessage(e) {\n    this.init ? this.iframe.contentWindow.postMessage(e, \"*\") : this.pendingRequests.push(e);\n  }\n  addListener() {\n    window.addEventListener('message', message => {\n      //console.log(message)\n\n      const {\n        data: {\n          id: id,\n          method: method,\n          service: service,\n          payload: payload\n        }\n      } = message;\n      if (service !== \"identity\") {\n        return;\n      }\n      if (method == 'initialize') {\n        this.handleInit(message);\n      } else if ('signedTransactionHex' in payload) {\n        console.log('signedTransactionHex', payload);\n        this.handleSign(payload);\n      } else if ('approvalRequired' in payload) {\n        console.log('approvalRequired', payload);\n        this.approveSignTx(this.transactionHex);\n      } else if (method == 'login') {\n        this.handleLogin(payload);\n      }\n    });\n  }\n}\nexport default DesoIdentity;","map":{"version":3,"names":["localStorageTTL","DesoIdentity","constructor","init","pm_id","source","user","pendingRequests","identityWindow","loginResolve","signTxResolve","IdentityUsersKey","transactionHex","addListener","loginAsync","accessLevel","Promise","resolve","reject","window","open","logout","publicKey","localStorage","removeItem","logoutAsync","signTxAsync","getInfo","id","uuid","JSON","parse","getItem","payload","accessLevelHmac","encryptedSeedHex","postMessage","service","method","approveSignTx","replace","c","r","Math","random","v","toString","console","log","handleLogin","close","users","publicKeyAdded","Object","keys","length","setWithExpiry","stringify","handleSign","signedTransactionHex","respond","e","t","n","handleInit","data","iframe","contentWindow","push","addEventListener","message"],"sources":["/Users/allenxu/projects/htv7/htv7/htv7/client/src/deso/desoIdentity.js"],"sourcesContent":["import localStorageTTL from \"../components/localStorageTTL\"\n\nclass DesoIdentity {\n  constructor() {\n    this.init = false\n    this.pm_id = ''\n    this.source = null\n    this.user = null\n    this.pendingRequests = []\n    this.identityWindow = null\n    this.loginResolve = null\n    this.signTxResolve = null\n    this.IdentityUsersKey = \"identityUsersV2\"\n    this.transactionHex = \"\"\n\n    this.addListener()\n  }\n\n  loginAsync(accessLevel) {\n    return new Promise((resolve, reject) => {\n      this.identityWindow = window.open('https://identity.deso.org/log-in?accessLevelRequest=' + accessLevel, null, 'toolbar=no, width=800, height=1000, top=0, left=0')\n      this.loginResolve = resolve\n    })\n  }\n\n  logout(publicKey) {\n    this.identityWindow = window.open('https://identity.deso.org/logout?publicKey=' + publicKey, null, 'toolbar=no, width=800, height=1000, top=0, left=0')\n    localStorage.removeItem(this.IdentityUsersKey)\n  }\n  \n  logoutAsync(publicKey) {\n    return new Promise((resolve, reject) => {\n      this.identityWindow = window.open('https://identity.deso.org/logout?publicKey=' + publicKey, null, 'toolbar=no, width=800, height=1000, top=0, left=0')\n      this.loginResolve = resolve\n    })\n  }\n\n  signTxAsync(transactionHex) {\n    return new Promise((resolve, reject) => {\n      this.signTxResolve = resolve\n      this.transactionHex = transactionHex\n      this.getInfo()\n      const id = this.uuid()\n      const user = JSON.parse(localStorage.getItem(this.IdentityUsersKey))\n      const payload = {\n        accessLevel: user.accessLevel,\n        accessLevelHmac: user.accessLevelHmac,\n        encryptedSeedHex: user.encryptedSeedHex,\n        transactionHex: transactionHex,\n      }\n      this.source.postMessage({\n        id: id,\n        service: 'identity',\n        method: 'sign',\n        payload: payload\n      }, \"*\")\n    })\n  }\n\n  approveSignTx(transactionHex) {\n    this.identityWindow = window.open('https://identity.deso.org/approve?tx=' + transactionHex, null, 'toolbar=no, width=800, height=1000, top=0, left=0')\n  }\n\n  uuid() {\n    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\n        var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);\n        return v.toString(16);\n    });\n  }\n\n  getInfo() {\n    console.log(\"getinfo\")\n    const id = this.uuid()\n\n      this.source.postMessage({\n        id: id,\n        service: 'identity',\n        method: 'info'\n      }, \"*\");\n  }\n\n  handleLogin(payload) {\n    console.log(payload);\n    if (this.identityWindow) {\n      this.identityWindow.close();\n      this.identityWindow = null;\n\n      const user = payload.users[payload.publicKeyAdded]\n\n      if (Object.keys(payload.users).length !== 0 && !user) {\n        return;\n      }\n\n      if (user) {\n        user['publicKey'] = payload.publicKeyAdded\n      }\n      localStorageTTL.setWithExpiry(this.IdentityUsersKey, JSON.stringify(user), 10000000000000);\n      this.loginResolve(user)\n    }\n  }\n\n  handleSign(payload) {\n    console.log(payload)\n\n    const signedTransactionHex = payload['signedTransactionHex']\n    if (this.identityWindow) {\n      this.identityWindow.close();\n      this.identityWindow = null\n    }\n    this.signTxResolve(signedTransactionHex)\n  }\n\n  respond(e, t, n) {\n    e.postMessage({\n      id: t,\n      service: \"identity\",\n      payload: n\n    }, \"*\")\n  }\n\n  handleInit(e) {\n    if (!this.init) {\n      this.init = true;\n\n      for (const e of this.pendingRequests) {\n        console.log(\"i'm in the pendingRequests loop\")\n        e.source.postMessage(e, \"*\");\n      }\n\n      this.pendingRequests = []\n      this.pm_id = e.data.id\n      this.source = e.source\n      console.log('this.source', this.source)\n    }\n    this.respond(e.source, e.data.id, {})\n  }\n\n  postMessage(e) {\n    this.init ? this.iframe.contentWindow.postMessage(e, \"*\") : this.pendingRequests.push(e)    \n  }\n\n  addListener() {\n    window.addEventListener('message', message => {\n      //console.log(message)\n\n      const { data: { id: id, method: method, service: service, payload: payload } } = message;\n      if (service !== \"identity\"){ return }\n\n\n      if (method == 'initialize') {\n          this.handleInit(message)\n      } else if ('signedTransactionHex' in payload) {\n          console.log('signedTransactionHex', payload)\n          this.handleSign(payload)\n      } else if ('approvalRequired' in payload) {\n          console.log('approvalRequired', payload)\n          this.approveSignTx(this.transactionHex)\n      } else if (method == 'login') {\n          this.handleLogin(payload)\n      }\n    })\n  }\n\n}\n\n\nexport default DesoIdentity"],"mappings":"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"},"metadata":{},"sourceType":"module"}